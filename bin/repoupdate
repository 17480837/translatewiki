#!/bin/bash
set -e

DIRSCRIPT="`dirname \"$0\"`"
DIRSCRIPT="`( cd \"$DIRSCRIPT\" && pwd )`"
DIRLOG=/home/betawiki/logs/repo
PROJECT=$1
WIKI=/www/translatewiki.net/w

DIR=$2
: ${DIR:=`pwd`}
source $DIRSCRIPT/findexportroot
cd "$DIR"

echo "$(date --rfc-3339=seconds --utc) [$(whoami) at $DIR] $0 $@" >> $DIRLOG

gitupdate() {
	local dir=$1
	cd $dir
	git fetch -q --all
	if [ -z "$2" ]
	then
		git reset -q --hard origin/master
	else
		git reset -q --hard origin/$2
	fi
	git clean -q -f -d
	git pull -q
	cd ..
}

GITUPDATEPROJECTS="\
commons-android \
commons-ios \
eol \
freecol \
frontlinesms \
fuel \
intuition \
jquery.uls \
kiwix \
mathjax
mifos \
pywikibot \
shapado \
vicuna \
waymarked-trails-site \
WikipediaMobile \
WikipediaMobileJ2ME \
wikireader \
WikisourceMobile \
WiktionaryMobile \
WLMMobile"

for i in $GITUPDATEPROJECTS; do
	if [ "$i" = "$PROJECT" ]
	then
		gitupdate "$PROJECT"
		exit 0
	fi
done

if [ "$PROJECT" = "blockly" ]
then
	svn up -q $PROJECT

elif [ "$PROJECT" = "etherpad-lite" ]
then
	gitupdate "$PROJECT" $REPO_ETHERPADLITE_BRANCH

elif [ "$PROJECT" = "fudforum" ]
then
	svn up -q $PROJECT

elif [ "$PROJECT" = "ihris" ]
then
	cd $PROJECT
	for MODULE in $REPO_IHRIS_MODULES
	do
		cd $MODULE
		bzr pull -q
		cd ..
	done

elif [ "$PROJECT" = "mantis" ]
then
	gitupdate "$PROJECT" $REPO_MANTIS_BRANCH

elif [ "$PROJECT" = "mediawiki" ]
then
	if [ -z "$REPO_MEDIAWIKI_BRANCHES" ]
	then echo "Add REPO_MEDIAWIKI_BRANCHES to REPOCONF"; exit 1
	fi

	cd $PROJECT
	for BRANCH in $REPO_MEDIAWIKI_BRANCHES
	do
		if [ ! -d "$BRANCH" ]
		then
			echo "$BRANCH not yet present. Cloning..."
			git clone "$REPO_MEDIAWIKI" "$BRANCH" -b "$BRANCH"
			if [ "$REPO_RW" = "yes" ]
			then
				cd "$BRANCH"
				git config user.name 'Translation updater bot'
				git config user.email 'l10n-bot@translatewiki.net'
				git config gitreview.username 'l10n-bot'
				git review -s
			fi
		else
			cd "$BRANCH"
			git fetch -q --all
			git reset -q --hard "origin/$BRANCH"
			git clean -q -f -d
		fi
		cd ..
	done
	cd ..

	wait
	if [ "$DIR" = "/resources/projects" ]
	then
		sudo -u betawiki php "$WIKI/extensions/Translate/scripts/createMessageIndex.php" --quiet || ${DIRSCRIPT}/udpcast Message index creation failed &
	fi

elif [ "$PROJECT" = "mediawiki-extensions" ]
then
	if [ -z "$REPO_MWEXTGIT" ]
	then echo "Add REPO_MWEXTGIT to REPOCONF"; exit 1
	fi

	cd $PROJECT
	cd extensions

	count=0
	EXTENSIONS=$(curl -s "https://gerrit.wikimedia.org/mediawiki-extensions.txt"|egrep -v "(FundraisingEmailUnsubscribe)")

	# Clone extension repos that do not exist yet.
	for EXTENSION in $EXTENSIONS
	do
		if [ ! -d "$EXTENSION/.git" ]
		then
			echo "Cloning $EXTENSION"
			git clone "$REPO_MWEXTGIT/$EXTENSION.git" "$EXTENSION"

			if [ "$REPO_RW" = "yes" ]
			then
				cd "$EXTENSION"
				git config user.name 'Translation updater bot'
				git config user.email 'l10n-bot@translatewiki.net'
				git config gitreview.username 'l10n-bot'
				if [ ! -e ".gitreview" ]
				then
					git remote add -f gerrit "$REPO_MWEXTGIT/$EXTENSION.git"
				fi
				git review -s
				cd ..
			fi
		fi
	done

	# Update all repos (yes, there is duplication for repos that were just cloned)
	echo $EXTENSIONS |
		xargs -n1 -P7 ${DIRSCRIPT}/update-reset-repo "$DIR/$PROJECT/extensions"

	if [ -z "$REPO_RW" ]
	then
		sudo -u betawiki php "$WIKI/extensions/Translate/scripts/processMessageChanges.php" --quiet --groups=ext-* && echo "Please check https://translatewiki.net/wiki/Special:ManageMessageGroups"
		sudo -u betawiki php "$WIKI/extensions/Translate/scripts/createMessageIndex.php" --quiet || ${DIRSCRIPT}/udpcast Message index creation failed &
	fi

elif [ "$PROJECT" = "mozilla" ]
then
	# This does not make sense if there are no supported languages.
	if [ -z "${REPO_MOZILLA_SUPPORTEDLANG}" ]
	then echo "Add REPO_MOZILLA_SUPPORTEDLANG to REPOCONF as currently no languages are supported"; exit 1
	fi

	cd ${PROJECT}

	for LANG in ${REPO_MOZILLA_SUPPORTEDLANG}
	do
		# Check if language has already been cloned. If not, do that.
		if [ ! -d "${LANG}" ]
		then
			echo "${LANG} was not yet cloned. Cloning..."
			if [ "$REPO_RW" = "yes" ]
			then
				hg clone ${REPO_MOZILLA_RW}${LANG}
				# Make it possible to use "hg strip".
				echo -e "\n[extensions]\nmq =" >> ${LANG}/.hg/hgrc
			else
				hg clone http://hg.mozilla.org/releases/l10n/mozilla-aurora/${LANG}
			fi
		fi

		cd ${LANG}

		if [ "$REPO_RW" = "yes" ]
		then
			# Undo local uncommitted changes.
			hg update -q -C
			# Revert back to latest repo version.
			while [ `b hg outgoing -l 1 |grep changeset |cut -d: -f2 |tr -d ' '` ]
			do
				REV=`b hg outgoing -l 1 |grep changeset |cut -d: -f2 |tr -d ' '`
				hg strip $REV
				echo "$REV stripped"
			done
		fi

		hg pull -q -u
		cd ..
	done

	# Update the source language.
	if [ -z "$REPO_RW" ]
	then
		cd mozilla-aurora
		hg update -q -C
		hg pull -q -u
	fi

elif [ "$PROJECT" = "mwlib" ]
then
	if [ "$REPO_RW" = "yes" ]
	then
		gitupdate "$PROJECT"
	fi

	gitupdate "mwlib.rl"

elif [ "$PROJECT" = "okawix" ]
then
	svn up -q $PROJECT

elif [ "$PROJECT" = "openimages" ]
then
	svn up -q $PROJECT

elif [ "$PROJECT" = "osm" ]
then
	gitupdate "$PROJECT"
	gitupdate "potlatch2"

elif [ "$PROJECT" = "wikia" ]
then
	gitupdate "$PROJECT" $REPO_WIKIA_BRANCH

elif [ "$PROJECT" = "wikiblame" ]
then
	svn up -q $PROJECT

else
	echo "`basename $0`: Unknown project"
	exit 1
fi
