#!/bin/bash
set -u

DIRSCRIPT="`dirname \"$0\"`"
DIRSCRIPT="`( cd \"$DIRSCRIPT\" && pwd )`"
DIRLOG=/home/betawiki/logs/repo
PROJECT=$1
WIKI=/srv/mediawiki/targets/production

DIR="${2:-`pwd`}"
source $DIRSCRIPT/findexportroot
cd "$DIR"

echo "$(date --rfc-3339=seconds --utc) [$(whoami) at $DIR] $0 $@" >> $DIRLOG

checkVar() {
	if [ -z "${!1:-}" ]
		then echo "Add ${1} to REPOCONF"; exit 1
	fi
}

doUpdate() {
	VAR="${1^^}"
	VAR="${VAR//-}"
	VAR="${VAR//./_}"
	VAR="REPO_$VAR"
	checkVar "$VAR"
	"$2" "${!VAR}" "$DIR/$1" "${3:-}"
	exit 0
}

processGroups() {
	if [ "${REPO_RW:-no}" = "no" ]
	then
		sudo -u betawiki php "$WIKI/extensions/Translate/scripts/processMessageChanges.php" --quiet --group="$1" &&
		echo "Please check https://translatewiki.net/wiki/Special:ManageMessageGroups"
	fi
}

# Ignore subrepos like Collection/OfflineContentGenerator
fetchReposFromGerrit() {
	curl -s "https://gerrit.wikimedia.org/r/projects/?p=$1" |
	grep "$1" |
	cut -d '"' -f2 |
	cut -d '/' -f3- |
	grep -v '/' |
	sort
}

CLUPDATE="$DIRSCRIPT/clupdate-git-repo";
if [ "${REPO_RW:-no}" = "yes" ]
then CLUPDATE_GERRIT="$DIRSCRIPT/clupdate-gerrit-repo";
else CLUPDATE_GERRIT="$DIRSCRIPT/clupdate-git-repo";
fi

GITCLUPDATE="\
crosswatch \
entryscape \
eol \
europeana \
freecol \
fuel \
huggle \
intuition \
int-orphantalk \
int-raun \
jquery.uls \
kiwix \
mantis \
mathjax \
nfcring-control \
vicuna \
waymarked-trails-site \
wikiblame \
wikiedudashboard \
wikipedia-android \
wikipedia-ios \
WikisourceMobile \
WiktionaryMobile"

for i in $GITCLUPDATE; do
	if [ "$i" = "$PROJECT" ]
	then
		doUpdate "$PROJECT" "$CLUPDATE"
	fi
done

GITCLUPDATE_GERRIT="\
pywikibot \
wikimania"

for i in $GITCLUPDATE_GERRIT; do
	if [ "$i" = "$PROJECT" ]
	then
		doUpdate "$PROJECT" "$CLUPDATE_GERRIT"
	fi
done

if [ "$PROJECT" = "blockly" ]
then
	doUpdate "blockly" "$CLUPDATE"
	doUpdate "blockly-games" "$CLUPDATE"

elif [ "$PROJECT" = "etherpad-lite" ]
then
	doUpdate "$PROJECT" "$CLUPDATE" $REPO_ETHERPADLITE_BRANCH

elif [ "$PROJECT" = "fudforum" ]
then
	svn up -q $PROJECT

elif [ "$PROJECT" = "ihris" ]
then
	cd $PROJECT
	for MODULE in $REPO_IHRIS_MODULES
	do
		cd $MODULE
		bzr pull -q
		cd ..
	done

elif [ "$PROJECT" = "inaturalist" ]
then
	doUpdate "$PROJECT" "$CLUPDATE" i18n

elif [ "$PROJECT" = "mifos" ]
then
	doUpdate "$PROJECT" "$CLUPDATE" develop

elif [ "$PROJECT" = "mediawiki" ]
then
	if [ -z "$REPO_MEDIAWIKI_BRANCHES" ]
	then echo "Add REPO_MEDIAWIKI_BRANCHES to REPOCONF"; exit 1
	fi

	echo "$REPO_MEDIAWIKI_BRANCHES" | tr ' ' '\n' |
		xargs -P4 -I___ "$CLUPDATE_GERRIT" "$REPO_MEDIAWIKI" "$DIR/$PROJECT/___" "___"

elif [ "$PROJECT" = "mediawiki-extensions" ]
then
	if [ -z "$REPO_MWEXTGIT" ]
	then echo "Add REPO_MWEXTGIT to REPOCONF"; exit 1
	fi

	echo "$(fetchReposFromGerrit mediawiki/extensions/)" |
		xargs -P4 -I___ "$CLUPDATE_GERRIT" "$REPO_MWEXTGIT/___.git" "$DIR/$PROJECT/extensions/___"

	REPOPREFIX="${REPO_MWEXTGIT%/mediawiki/extensions}"
	"$CLUPDATE_GERRIT" "$REPOPREFIX/oojs/ui.git" "$DIR/$PROJECT/extensions/oojs-ui"
	"$CLUPDATE_GERRIT" "$REPOPREFIX/VisualEditor/VisualEditor.git" "$DIR/$PROJECT/extensions/VisualEditorVisualEditor"

	processGroups "ext-*"

elif [ "$PROJECT" = "mediawiki-skins" ]
then
	if [ -z "$REPO_MWSKINGIT" ]
	then echo "Add REPO_MWSKINGIT to REPOCONF"; exit 1
	fi

	echo "$(fetchReposFromGerrit mediawiki/skins/)" |
		xargs -P4 -I___ "$CLUPDATE_GERRIT" "$REPO_MWSKINGIT/___.git" "$DIR/$PROJECT/___"

	processGroups "mediawiki-skin-*"

elif [ "$PROJECT" = "nocc" ]
then
	svn up -q $PROJECT

elif [ "$PROJECT" = "osm" ]
then
	doUpdate "$PROJECT" "$CLUPDATE"
	doUpdate "potlatch2" "$CLUPDATE"

else
	echo "`basename $0`: Unknown project"
	exit 1
fi
